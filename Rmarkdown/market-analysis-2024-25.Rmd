---
title: "<b>Portugal Market Analysis</b>"
output: 
  flexdashboard::flex_dashboard:
    source_code: embed
    orientation: columns
    vertical_layout: fill
    theme: simplex
editor_options: 
  chunk_output_type: console
runtime: shiny
---
<!-- theme alternatives: "cerulean",  "journal", "readable", "simplex", "united", "yeti" -->

```{r SETUP, message=FALSE, include=FALSE}
#GENERAL CODE CHUNK SETUP
knitr::opts_chunk$set(echo = FALSE, message=FALSE)

#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-#
#PACKAGE INSTALLATION AND LOADING
#-the essential packages required to load the document are markdown, knitr, flexdashboard and pacman.
#-the following code checks for their installation, installing them if required, and proceeds
#-to install/load other necessary packages.

if(!require("markdown")) install.packages("markdown")
if(!require("knitr")) install.packages("knitr")
if(!require("flexdashboard")) install.packages("flexdashboard")
if(!require("pacman")) install.packages("pacman") 
#--pacman function essential for loading and installing (if not already installed) packages together

pacman::p_load(
  knitr,           #--essential for rmarkdown document modification
  tidyverse,       #--contains ggplot2, readr, tibble, dplyr, magrittr
  reactable,       #--for creation of large tables
  janitor,         #--manipulation, summarisation of messy data, plus duplicate detection
  inspectdf,       #--dataframe inspection, relative to value (used in dataset analysis)
  highcharter,     #--interactive data visualisation
  htmltools,       #--website page options (zoom, scrolling)
  collapsibleTree, #--for happiness factor collapsible tree
  broom,           #--needed to convert linear model for interpolation line into dataframe
  dygraphs,        #--package for time series model creation
  xts,             #--data format required by dygraphs
  shiny,           #--"runtime: shiny" in JMAL header already loads the library, useful for debugging w/o                       knitting
  shinyWidgets     #--additional customisation for shiny elements
)
```


```{r FUNCTIONS & DATA IMPORTING, message=FALSE, include=FALSE}
#FUNCTIONS
#-".csv" extension remover, for variable list
csv_remove <- 
  function(x){
    substr(x, 1, nchar(x)-4)
  }

#-----#

#HIGHCHARTER() SCATTERPLOT FORMAT
scplot_custom <- function(x){ 
  x %>% 
    hc_title(style=list(
               fontWeight="bold",
               fontSize= "15px",
               fontFamily= "Lato"
              )
             ) %>% 
    hc_size(., width=80, height=310) %>% 
    hc_tooltip(., 
       headerFormat = "",
       pointFormat = 
         "<b>{point.name}</b><br>X: {point.x:.1f}%<br>Y: {point.y:.2f}") %>% 
    hc_yAxis(
      type="linear",
      lineWidth=5,
      labels=list(format="{value}/10"),
      lineColor="#ecf0f1") %>% 
    hc_xAxis(
      type="linear",
      lineWidth=5,
      labels=list(format="{value}%"), 
      lineColor="#ecf0f1") %>% 
    hc_plotOptions(., scatter=list(color="#db240c"))
  }

#-----#

#HIGHCHARTER LINE CHART FORMAT
lnplot_custom <- function(x){
  x %>% 
    hc_title(style=list(
               fontWeight="bold",
               fontSize= "15px",
               fontFamily= "Lato"
              )
             ) %>% 
    hc_size(width = NULL, height = 350) %>% 
    hc_yAxis(
      type="linear",
      lineWidth=5,
      labels=list(format="{value}"),
      lineColor="#ecf0f1") %>%
    hc_xAxis(
      type="linear",
      lineWidth=5,
      labels=list(format="{value}"), 
      lineColor="#ecf0f1") %>% 
    hc_tooltip(., 
       headerFormat = "",
       pointFormat = 
         "<b>{point.name}</b><br>
          Year: {point.x:.f}<br>Population: {point.y:.f}") %>% 
    hc_plotOptions(.,line=list(color="#db240c"))

    
  
}

#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-#

#DATA IMPORTING
#when downloading the file, the working directory should automatically set to the path where the Markdown file is saved. if that does not occur, copy the Markdown from the dropdown menu between the "" and run the single line of code.
setwd("C:/Users/busop/All Files - ORIGINAL FILES OF DESKTOP LINKS/Github/market-analysis-2024-2025/Rmarkdown")

dsets <- list.files(path="./Datasets", pattern = "*.csv", full.names = FALSE)   #vector with file names

dsets <-
  #assign the value contained in each dataset to its respective name
  setNames(
    lapply(list.files(path= "./Datasets", pattern="*.csv", full.names = TRUE), read.csv), 
    #reading each csv file, same code as dsets w/ exception that it takes full file path rather than just the name
    lapply(dsets, csv_remove)
    #removing ".csv" file extension to create variable list, function above
  )

#final dsets vector contains variables associated w/ respective dataset:
#-global edits done to reduce variable names, since discarded data not required.
#-method flexible to increases, decreases or variations in order to dataset directory.
```



<!-- INTRODUCTION PAGE -->

# Introduction

<!-- DEFINITIONS SECTION -->

## Definitions and Graph {data-width="400"}

### **Research Question and Definitions**

Fruit Snacks, Snack Bars, Sweet Biscuits in Portugal and the strategy of *Vieira de Castro & Filhos Lda.* in that market.

- What is a snack?
  - "A small meal or amount of food, usually eaten in a hurry." (definition from Oxford Dictionary)
- What types of snack do we consider?
  - Fruit Snacks (dried fruit, processed fruit snacks).
  - Snack Bars (cereal bars, protein/energy bars, fruit and nut bars, other snack
  bars).
  - Sweet Biscuits (chocolate coated biscuits, cookies, filled biscuits, plain
  biscuits, wafers).
- How do we outline the snack market?
  - The Portuguese market consists of the production and retail sales of dried
  fruit, processed fruit snacks, cereal bars, energy bars, fruit and nut bars,
  other snack bars, chocolate coated biscuits, cookies, filled biscuits, plain
  biscuits, wafers.
  - The market is valued according to retail selling price (RSP) and includes any
  applicable taxes (definition from Euromonitor).

<!-- INDEX SECTION -->

### **Index**
```{r REPORT FACTOR WEB}
Index <- 
  data.frame(
    parent = c(rep("Socio-Demographic Analysis", 4), rep("Economic Analysis", 4),                rep("Demand and Supply", 3)),
    child = c("Population", "Health Factors", "Parallel with Italy and Spain",                  "Wealth Distribution", "General Economic Overview", "Snack Market",               "Vieira de Castro & Filhos Lda.", "Main Market Actors", "Supply and                Demand Fluctuations", "Hypotheticals tied to the good", "Effect of                Externalities")
  )

collapsibleTree(Index, hierarchy = c("parent", "child"), collapsed = FALSE, 
                width = 600, height = NULL, tooltip = FALSE, fontSize= 10, fill= "#db240c")

```

<!-- ANALYSIS METHODS SECTION -->

## Analysis Methods {data-width="600"}

<!-- PREMISES TO INFERENCE SUBSECTION -->

###

####

##### **Premises to Inference**

The purpose of this section is to state the principles behind our statistical inference. 
In order to treat the data as objectively as possible, specific behaviours and procedures 
were followed in regards to the making of the report. Our aim is limiting bias and
presenting information through truthful representations.

In order to achieve reliable conclusions, we must conform to a rigid information 
selection process, in accordance with the following principles:

- Pertaining to quantitative information and assessing qualitative sources with
care.
- Thoroughly checking the validity, completeness and accessibility of the
information gathered online.
- Since our data is primarily secondary, ensuring that the external sources
  from which we collect data are reliable.
  - Information mainly gathered from Eurostat (Passport data) and OurWorldinData.

Additionally, to avoid indirect manipulation of the data, much care was placed in
choosing the kinds of graphical representations added to the report. Moreso, our 
analysis was founded upon standardised values so as to guarantee truthful trends
evolving coherently  to specified indexes. 

<!-- CHALLENGES FACED SUBSECTION -->

####

##### **Challenges Faced**

Throughout the analysis, we incurred in a series of problems that complicated our
operations. It is to be expected that a research on a topic as expansive as a
market leads to fragmented conclusions or unsatisfactory outcomes. Some issues
faced were:

- Lack of public data for the company of study.
- Discordant data between sources.
- Lack of confidence in some data correlation.

<!-- OVERCOMING CHALLENGES SUBSECTION -->

####

##### **Overcoming Challenges**

To face the set of complications mentioned previously, our initial approach was 
to evaluate the quality of our available sources. A consideration we had to make
regarded using data with no adjacent studies, which deprived us of the possibility of 
performing any kind of cross-analysis. Moreso, in situations where varied sources
would conflict, we would resort to addressing only the most reliable of those 
considered, following a form of hierarchy of information quality. The aforementioned 
order would peak with governmental-linked information, followed up by trustworthy 
data providers. In total, we attempted to:

- Contact the company to obtain relevant information.
  - Resorting to a brand analysis for lack of response and of alternatives.
- Cross-referencing information sources.
- Attainment at a strict data evaluation hierarchy. 




<!-- SOCIO-DEMOGRAPHICS PAGE -->

# Socio-Demographic Factors

<!-- POPULATION SECTION -->

## Population {.tabset .tabset-fade data-width="650"}

<!-- TAB 1 DEMOGRAPHICS -->

### **Demographic Data**

The primary element to consider when trying to understand Portuguese society is 
population. Data from the past 200 years shows a exponential demographic increase in the 20th century. This can be explained by a series of factors, namely a general betterment of living conditions in Europe following the industrial revolutions, with the gradual diffusion of better economic, social, political, educational and sanitary conditions in the modern world. Important to mention is the period of general peace following the Second World War, as contexts offering stability and security favour demographic growth.

Another relevant information regards that of population density. Analysing this statistic in the same timespan, we notice a  fluctuating trend common throughout the entire 
 
  
   
    

```{r PORTUGAL DEMOGRAPHICS}
#CREATION OF CLEAN POPULATION, POPULATION DENSITY DATASETS
clean_population <- 
  dsets[["portugal_population"]] %>% 
  filter(Year >= 1800 & Entity == "Portugal") %>% 
  select(-Code, -Entity) %>% 
  rename(`Population` = Population..historical.) 
  
clean_population_density <-
  dsets[["portugal_population_density"]] %>% 
  filter(Year >= 1800 & Entity == "Portugal" & Year <= 2023) %>% 
  select(-Code, -Entity) %>% 
  rename(`Population Density` = Population.density)

pop_ui <-
  fluidPage({
    sidebarLayout(
      mainPanel(
        width = 8,
        highchartOutput(
          outputId = "selected_pop",
          width = "500px",
          height = "400px"
        )
      ),
      
      sidebarPanel(
        width = 4,
        pickerInput(
          inputId = "pop_choice",
          label = "Population Graphs",
          choices = c("Population", "Population Density"),
          selected = "Population",
          options = list(style = "btn-danger"),
          width = "100%"
        )
      ),
      
      position = c("left", "right")
    )
  })


pop_server_logic <- function(input, output){
  output$selected_pop <- renderHighchart({
    selected_pop_graph <- reactive({
      switch(input$pop_choice,
             "Population" = clean_population,
             "Population Density" = clean_population_density)
    })
    
    pop_y_axis <- 
      switch(input$pop_choice,
             "Population" = "Population",
             "Population Density" = "Population Density") 

    pop_title <- 
      switch(input$pop_choice,
             "Population" = "Population",
             "Population Density" = "Population Density")
      
    selected_pop_graph() %>% 
      hchart("line", hcaes(x = `Year`, y = !!sym(pop_y_axis))) %>% 
      hc_title(text = "Population and Population Density Charts") %>%
      # hc_xAxis(title= list("Year"), align="middle") %>%
      hc_yAxis(align="middle") %>%
      lnplot_custom(.)
  })
}

shinyApp(ui = pop_ui, server = pop_server_logic)
```

<!-- TAB 2 HEALTH -->

### **Portuguese General Health**

filler

```{r PORTUGAL HEALTH}
7*2
```

<!-- TAB 3 WEALTH -->

### **Wealth Distribution**

filler

```{r PORTUGAL WEALTH}
6+6
```

<!-- PARALLELS SECTION -->

## Parallels with Italy and Spain {data-width = "450"}

###



```{ShinyUI PORTUGAL SPAIN ITALY PARALLELS r}
2+2
```

<!-- INTRODUCTION PAGE -->

# Economic Overview

<!-- SECTION 1 -->

## Section 1

###

```{r}
```


